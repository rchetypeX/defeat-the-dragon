"use strict";(()=>{var e={};e.id=581,e.ids=[581],e.modules={399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},2615:e=>{e.exports=require("http")},5240:e=>{e.exports=require("https")},8621:e=>{e.exports=require("punycode")},6162:e=>{e.exports=require("stream")},7360:e=>{e.exports=require("url")},1568:e=>{e.exports=require("zlib")},3031:(e,s,r)=>{r.r(s),r.d(s,{originalPathname:()=>f,patchFetch:()=>x,requestAsyncStorage:()=>m,routeModule:()=>c,serverHooks:()=>k,staticGenerationAsyncStorage:()=>I});var t={};r.r(t),r.d(t,{POST:()=>l});var o=r(3036),a=r(5736),i=r(5262),n=r(942),p=r(6981),d=r(8046);let u=(0,p.eI)("https://zbqrrtjmavergvuddncs.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpicXJydGptYXZlcmd2dWRkbmNzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU3MDcyNDYsImV4cCI6MjA3MTI4MzI0Nn0.F54csPdpCI6BBhc5NJ5HHJv7LU9xGUGLO1oeGzfUPHE");async function l(e){try{let s,r;let t=e.headers.get("authorization");if(!t||!t.startsWith("Bearer "))return n.NextResponse.json({error:"Missing or invalid authorization header"},{status:401});let o=t.substring(7);if("mock-token-for-development"===o)console.log("API: Using mock token, skipping Supabase auth");else{let{data:{user:e},error:s}=await u.auth.getUser(o);if(s||!e)return n.NextResponse.json({error:"Invalid or expired token"},{status:401})}let a=(0,p.eI)("https://zbqrrtjmavergvuddncs.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpicXJydGptYXZlcmd2dWRkbmNzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU3MDcyNDYsImV4cCI6MjA3MTI4MzI0Nn0.F54csPdpCI6BBhc5NJ5HHJv7LU9xGUGLO1oeGzfUPHE",{global:{headers:{Authorization:`Bearer ${o}`}}}),i=await e.json(),l=d.CompleteSessionRequest.safeParse(i);if(!l.success)return n.NextResponse.json({error:"Invalid request data",details:l.error},{status:400});let{session_id:c,actual_duration_minutes:m,disturbed_seconds:I,outcome:k}=l.data,f=null;if("mock-token-for-development"===o)s={id:c,user_id:"mock-user-id",action:"Train",started_at:new Date(Date.now()-3e5).toISOString(),ended_at:null,disturbed_seconds:I,dungeon_floor:0,boss_tier:"none"},r={id:"mock-player-id",user_id:"mock-user-id",level:1,xp:0,coins:3,sparks:0,is_inspired:!1,bond_score:50,mood_state:"Happy",day_streak:0,created_at:new Date().toISOString()};else{let{data:{user:e},error:t}=await u.auth.getUser(o);if(t||!e)return n.NextResponse.json({error:"Invalid or expired token"},{status:401});f=e;let{data:i,error:p}=await a.from("sessions").select("*").eq("id",c).eq("user_id",f.id).single();if(p||!i)return n.NextResponse.json({error:"Session not found or access denied"},{status:404});if((s=i).ended_at)return n.NextResponse.json({error:"Session already completed"},{status:400});let{data:d,error:l}=await a.from("players").select("*").eq("user_id",f.id).single();if(l||!d)return n.NextResponse.json({error:"Player data not found"},{status:404});r=d}let x=0,g=0,v=0,_=!1,h=r.level,y=!1,b=r.day_streak;if("success"===k){if(x=(0,d.computeXP)(m,s.action,r.day_streak),g=(0,d.computeCoins)(m),"mock-token-for-development"===o)r.is_inspired&&(v=(0,d.computeSparks)(m,!0));else{let{data:e}=await a.from("subscriptions").select("*").eq("user_id",f?.id).eq("status","active").single();e&&(v=(0,d.computeSparks)(m,!0))}let e=r.xp+x,t=(0,d.computeLevel)(e);_=t>r.level,h=t,b=r.day_streak+1,y=!0}if("mock-token-for-development"===o)console.log("API: Mock session completion - simulating database updates");else{let{error:e}=await a.from("sessions").update({ended_at:new Date().toISOString(),outcome:k,disturbed_seconds:I}).eq("id",c);if(e)return console.error("Error updating session:",e),n.NextResponse.json({error:"Failed to update session"},{status:500});let{error:s}=await a.from("players").update({xp:r.xp+x,coins:r.coins+g,sparks:r.sparks+v,level:h,day_streak:b}).eq("user_id",f?.id);if(s)return console.error("Error updating player:",s),n.NextResponse.json({error:"Failed to update player data"},{status:500})}let N={xp_gained:x,coins_gained:g,sparks_gained:v,level_up:_,new_level:h,streak_updated:y,new_streak:b};return n.NextResponse.json(N)}catch(e){return console.error("Session complete error:",e),n.NextResponse.json({error:"Internal server error"},{status:500})}}let c=new o.AppRouteRouteModule({definition:{kind:a.x.APP_ROUTE,page:"/api/sessions/complete/route",pathname:"/api/sessions/complete",filename:"route",bundlePath:"app/api/sessions/complete/route"},resolvedPagePath:"C:\\Users\\EL Bonuan\\Documents\\GitHub\\defeat-the-dragon\\apps\\web\\app\\api\\sessions\\complete\\route.ts",nextConfigOutput:"",userland:t}),{requestAsyncStorage:m,staticGenerationAsyncStorage:I,serverHooks:k}=c,f="/api/sessions/complete/route";function x(){return(0,i.patchFetch)({serverHooks:k,staticGenerationAsyncStorage:I})}}};var s=require("../../../../webpack-runtime.js");s.C(e);var r=e=>s(s.s=e),t=s.X(0,[193,746,981,705,46],()=>r(3031));module.exports=t})();
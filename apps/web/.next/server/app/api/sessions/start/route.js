"use strict";(()=>{var e={};e.id=150,e.ids=[150],e.modules={399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},2615:e=>{e.exports=require("http")},5240:e=>{e.exports=require("https")},8621:e=>{e.exports=require("punycode")},6162:e=>{e.exports=require("stream")},7360:e=>{e.exports=require("url")},1568:e=>{e.exports=require("zlib")},5987:(e,s,t)=>{t.r(s),t.d(s,{originalPathname:()=>h,patchFetch:()=>P,requestAsyncStorage:()=>I,routeModule:()=>p,serverHooks:()=>m,staticGenerationAsyncStorage:()=>g});var r={};t.r(r),t.d(r,{POST:()=>c});var o=t(3036),n=t(5736),i=t(5262),a=t(942),l=t(6981),d=t(8046);let u=(0,l.eI)("https://zbqrrtjmavergvuddncs.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpicXJydGptYXZlcmd2dWRkbmNzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU3MDcyNDYsImV4cCI6MjA3MTI4MzI0Nn0.F54csPdpCI6BBhc5NJ5HHJv7LU9xGUGLO1oeGzfUPHE");async function c(e){console.log("API: POST /sessions/start called");try{let s,t;let r=e.headers.get("authorization");if(console.log("API: Auth header present:",!!r),!r||!r.startsWith("Bearer "))return console.log("API: Invalid auth header"),a.NextResponse.json({error:"Missing or invalid authorization header"},{status:401});let o=r.substring(7);console.log("API: Token extracted, length:",o.length),"mock-token-for-development"===o?console.log("API: Using mock token, skipping Supabase auth"):console.log("API: Will verify user token when creating session");let n=(0,l.eI)("https://zbqrrtjmavergvuddncs.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpicXJydGptYXZlcmd2dWRkbmNzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU3MDcyNDYsImV4cCI6MjA3MTI4MzI0Nn0.F54csPdpCI6BBhc5NJ5HHJv7LU9xGUGLO1oeGzfUPHE",{global:{headers:{Authorization:`Bearer ${o}`}}});console.log("API: Parsing request body...");let i=await e.json();console.log("API: Request body:",i),console.log("API: Validating request...");let c=d.StartSessionRequest.safeParse(i);if(console.log("API: Validation result:",{success:c.success}),!c.success)return console.log("API: Validation failed:",c.error),a.NextResponse.json({error:"Invalid request data",details:c.error},{status:400});let{action:p,duration_minutes:I}=c.data;console.log("API: Validated data:",{action:p,duration_minutes:I});let g=(0,d.actionForMinutes)(I);if(p!==g)return a.NextResponse.json({error:`Action ${p} does not match duration ${I} minutes`},{status:400});let m=new Date,h=new Date(m.getTime()+6e4*I),P=crypto.randomUUID();console.log("API: Creating session in database...");let b=null;if("mock-token-for-development"===o)s={id:crypto.randomUUID(),user_id:"mock-user-id",action:p,started_at:m.toISOString(),disturbed_seconds:0,dungeon_floor:0,boss_tier:"none"},t=null,console.log("API: Created mock session");else{let{data:{user:e},error:r}=await u.auth.getUser(o);if(r||!e)return a.NextResponse.json({error:"Invalid or expired token"},{status:401});b=e;let{data:i,error:l}=await n.from("sessions").insert({user_id:b.id,action:p,started_at:m.toISOString(),disturbed_seconds:0,dungeon_floor:0,boss_tier:"none"}).select().single();s=i,t=l}if(console.log("API: Database result:",{hasSession:!!s,hasError:!!t}),t)return console.error("Database error creating session:",t),a.NextResponse.json({error:`Failed to create session: ${t.message}`},{status:500});console.log("API: Preparing response...");let x={session_id:s.id,expected_end_time:h.toISOString(),nonce:P};return console.log("API: Sending response:",x),a.NextResponse.json(x)}catch(e){return console.error("Session start error:",e),a.NextResponse.json({error:"Internal server error"},{status:500})}}let p=new o.AppRouteRouteModule({definition:{kind:n.x.APP_ROUTE,page:"/api/sessions/start/route",pathname:"/api/sessions/start",filename:"route",bundlePath:"app/api/sessions/start/route"},resolvedPagePath:"C:\\Users\\EL Bonuan\\Documents\\GitHub\\defeat-the-dragon\\apps\\web\\app\\api\\sessions\\start\\route.ts",nextConfigOutput:"",userland:r}),{requestAsyncStorage:I,staticGenerationAsyncStorage:g,serverHooks:m}=p,h="/api/sessions/start/route";function P(){return(0,i.patchFetch)({serverHooks:m,staticGenerationAsyncStorage:g})}}};var s=require("../../../../webpack-runtime.js");s.C(e);var t=e=>s(s.s=e),r=s.X(0,[193,746,981,705,46],()=>t(5987));module.exports=r})();
"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[569],{6569:function(e,s,r){r.d(s,{AuthProvider:function(){return d},a:function(){return c}});var t=r(7573),o=r(7653),n=r(1867),a=r(5485),i=r(4012);let l=(0,o.createContext)(void 0);function d(e){let{children:s}=e,[r,d]=(0,o.useState)(null),[c,u]=(0,o.useState)(null),[g,p]=(0,o.useState)(!0),{setUser:y,resetGame:m}=(0,a.g)();(0,o.useEffect)(()=>{n.O.auth.getSession().then(async e=>{var s;let{data:{session:r}}=e;if(u(r),d(null!==(s=null==r?void 0:r.user)&&void 0!==s?s:null),p(!1),null==r?void 0:r.user){y({id:r.user.id,email:r.user.email});try{let e=await (0,i.v_)();e&&a.g.getState().setPlayer(e)}catch(e){console.error("Failed to load player data:",e)}}});let{data:{subscription:e}}=n.O.auth.onAuthStateChange(async(e,s)=>{var r;if(u(s),d(null!==(r=null==s?void 0:s.user)&&void 0!==r?r:null),p(!1),null==s?void 0:s.user){y({id:s.user.id,email:s.user.email});try{let e=await (0,i.v_)();e&&a.g.getState().setPlayer(e)}catch(e){console.error("Failed to load player data:",e)}}else y(null),m()});return()=>e.unsubscribe()},[y,m]);let h=async(e,s)=>{let{error:r}=await n.O.auth.signInWithPassword({email:e,password:s});return{error:r}},P=async(e,s,r)=>{try{let t=await fetch("/api/auth/check-email",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:e})});if(t.ok&&(await t.json()).exists)return{error:{message:"An account with this email already exists. Please sign in instead."}};let{error:o}=await n.O.auth.signUp({email:e,password:s,options:{data:{display_name:r},emailRedirectTo:"".concat(window.location.origin,"/auth/callback")}});if(o){if(console.log("Sign up error:",o.message),o.message.includes("already registered")||o.message.includes("already exists")||o.message.includes("User already registered")||o.message.includes("duplicate key")||o.message.includes("already been registered")||o.message.includes("User already registered")||o.message.includes("Email already registered"))return{error:{message:"An account with this email already exists. Please sign in instead."}};if(o.message.includes("password")||o.message.includes("Password"))return{error:{message:"Password must be at least 6 characters long."}};if(o.message.includes("email")||o.message.includes("Email"))return{error:{message:"Please enter a valid email address."}};return{error:o}}return{error:null}}catch(e){return console.error("Sign up error:",e),{error:{message:"An unexpected error occurred. Please try again."}}}},S=async()=>{await n.O.auth.signOut()};return(0,t.jsx)(l.Provider,{value:{user:r,session:c,loading:g,signIn:h,signUp:P,signOut:S},children:s})}function c(){let e=(0,o.useContext)(l);if(void 0===e)throw Error("useAuth must be used within an AuthProvider");return e}},4012:function(e,s,r){r.d(s,{Xr:function(){return i},v_:function(){return l},yj:function(){return a}});var t=r(1867);async function o(){return console.log("API: Getting auth token..."),console.log("API: Using mock token for development"),"mock-token-for-development"}async function n(e){let s=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};console.log("API: Making request to:",e);let r=await o();console.log("API: Got token, length:",r.length);let t=new AbortController,n=setTimeout(()=>{console.log("API: Request timeout, aborting..."),t.abort()},15e3);try{console.log("API: Making fetch request...");let o=await fetch("/api".concat(e),{...s,signal:t.signal,headers:{"Content-Type":"application/json",Authorization:"Bearer ".concat(r),...s.headers}});if(clearTimeout(n),console.log("API: Fetch request completed"),console.log("API: Response status:",o.status),!o.ok){let e=await o.json().catch(()=>({}));throw console.error("API: Request failed:",e),Error(e.error||"API request failed: ".concat(o.status))}let a=await o.json();return console.log("API: Request successful, data:",a),a}catch(e){if(clearTimeout(n),"AbortError"===e.name)throw console.error("API: Request timed out"),Error("Request timed out");throw e}}async function a(e){console.log("API: startSession called with:",e);try{let s=await n("/sessions/start",{method:"POST",body:JSON.stringify(e)});return console.log("API: startSession response:",s),s}catch(e){throw console.error("API: startSession error:",e),e}}async function i(e){return n("/sessions/complete",{method:"POST",body:JSON.stringify(e)})}async function l(){try{var e;console.log("API: getPlayerData called"),console.log("API: Starting getPlayerData execution");let{data:{user:s}}=await t.O.auth.getUser();if(console.log("API: Auth user check completed, user:",s?"exists":"null"),!s)return console.log("API: No authenticated user, returning mock data"),{id:"mock-player-id",user_id:"mock-user-id",level:1,xp:0,coins:3,sparks:0,is_inspired:!1,bond_score:50,mood_state:"Happy",day_streak:0,created_at:new Date().toISOString(),display_name:"The Moth"};console.log("API: Starting database queries for user:",s.id),console.log("API: Querying players table...");let r=await t.O.from("players").select("*").eq("user_id",s.id).single();console.log("API: Players query completed, error:",r.error),console.log("API: Querying profiles table...");let o=await t.O.from("profiles").select("display_name").eq("user_id",s.id).single();if(console.log("API: Profiles query completed, error:",o.error),console.log("API: All database queries completed"),r.error)throw console.error("API: Players table query failed:",r.error),Error("Players query failed: ".concat(r.error.message));o.error&&console.error("API: Profiles table query failed:",o.error);let n={...r.data,display_name:(null===(e=o.data)||void 0===e?void 0:e.display_name)||"The Moth"};return console.log("API: Successfully retrieved player data:",{id:n.id,level:n.level,xp:n.xp,coins:n.coins,display_name:n.display_name}),console.log("API: getPlayerData completed successfully"),n}catch(e){throw console.error("API: Failed to get player data:",e),console.error("API: getPlayerData failed with error:",e.message),e}}},5485:function(e,s,r){r.d(s,{g:function(){return i}});var t=r(7582),o=r(4452),n=r(4012);let a={user:{id:null,email:null,isAuthenticated:!1},player:null,currentSession:null,inventory:[],classes:[],settings:{soundEnabled:!0,notificationsEnabled:!0,accessibility:{highContrast:!1,dyslexiaFont:!1,ttsEnabled:!1}},sessionProgress:{sessionId:null,startTime:null,durationMinutes:null,elapsedSeconds:0,isActive:!1,isDisturbed:!1,disturbedSeconds:0}},i=(0,t.Ue)()((0,o.mW)((0,o.tJ)((e,s)=>({...a,setUser:s=>e(e=>({user:s?{id:s.id,email:s.email,isAuthenticated:!0}:{id:null,email:null,isAuthenticated:!1}})),setPlayer:s=>e({player:s}),updatePlayer:s=>e(e=>({player:e.player?{...e.player,...s}:null})),loadPlayerData:async()=>{try{console.log("Store: Loading player data...");let s=await (0,n.v_)();console.log("Store: Player data loaded:",s),s?(console.log("Store: Setting player data in store"),e({player:s}),console.log("Store: Player data set successfully")):(console.log("Store: No player data returned"),e({player:null}))}catch(s){throw console.error("Store: Failed to load player data:",s),e({player:null}),s}},setCurrentSession:s=>e({currentSession:s}),startSession:async(r,t)=>{try{console.log("Store: Starting session with:",{action:r,durationMinutes:t});let o=await (0,n.yj)({action:r,duration_minutes:t});console.log("Store: API response:",o);let a={id:o.session_id,user_id:s().user.id,action:r,started_at:new Date().toISOString(),disturbed_seconds:0,dungeon_floor:0,boss_tier:"none"};console.log("Store: Created session object:",a),e({currentSession:a,sessionProgress:{sessionId:o.session_id,startTime:Date.now(),durationMinutes:t,elapsedSeconds:0,isActive:!0,isDisturbed:!1,disturbedSeconds:0}}),console.log("Store: Session state updated")}catch(o){console.error("Store: Failed to start session:",o);let s={id:"mock-session-id",user_id:"mock-user-id",action:r,started_at:new Date().toISOString(),disturbed_seconds:0,dungeon_floor:0,boss_tier:"none"};console.log("Store: Using mock session:",s),e({currentSession:s,sessionProgress:{sessionId:"mock-session-id",startTime:Date.now(),durationMinutes:t,elapsedSeconds:0,isActive:!0,isDisturbed:!1,disturbedSeconds:0}})}},stopSession:()=>e(e=>({currentSession:null,sessionProgress:{...e.sessionProgress,isActive:!1}})),completeSession:async r=>{try{let t=s();if(!t.currentSession||!t.sessionProgress.sessionId)throw Error("No active session to complete");let o=Math.floor((Date.now()-t.sessionProgress.startTime)/6e4);console.log("Completing session with:",{sessionId:t.currentSession.id,actualDurationMinutes:o,disturbedSeconds:t.sessionProgress.disturbedSeconds,outcome:r});let a=await (0,n.Xr)({session_id:t.currentSession.id,actual_duration_minutes:o,disturbed_seconds:t.sessionProgress.disturbedSeconds,outcome:r});return console.log("Session completion response:",a),t.player&&(console.log("Store: Updating player data with rewards:",{oldPlayer:t.player,rewards:{xp_gained:a.xp_gained,coins_gained:a.coins_gained,sparks_gained:a.sparks_gained,new_level:a.new_level,new_streak:a.new_streak}}),e({player:{...t.player,xp:t.player.xp+a.xp_gained,coins:t.player.coins+a.coins_gained,sparks:t.player.sparks+a.sparks_gained,level:a.new_level,day_streak:a.new_streak},currentSession:null,sessionProgress:{...t.sessionProgress,isActive:!1}}),console.log("Store: Player data and session state updated")),a}catch(a){var t,o;console.error("Failed to complete session:",a);let r=s(),n={xp_gained:10,coins_gained:5,sparks_gained:(null===(t=r.player)||void 0===t?void 0:t.is_inspired)?2:0,level_up:!1,new_level:(null===(o=r.player)||void 0===o?void 0:o.level)||1,new_streak:1};return console.log("Store: Using mock completion response:",n),r.player&&e({player:{...r.player,xp:r.player.xp+n.xp_gained,coins:r.player.coins+n.coins_gained,sparks:r.player.sparks+n.sparks_gained,level:n.new_level,day_streak:n.new_streak},currentSession:null,sessionProgress:{...r.sessionProgress,isActive:!1}}),n}},updateSessionProgress:s=>e(e=>({sessionProgress:{...e.sessionProgress,...s}})),setInventory:s=>e({inventory:s}),addToInventory:s=>e(e=>({inventory:[...e.inventory,s]})),updateInventoryItem:(s,r)=>e(e=>({inventory:e.inventory.map(e=>e.id===s?{...e,...r}:e)})),setClasses:s=>e({classes:s}),unlockClass:s=>e(e=>({classes:e.classes.map(e=>e.class_id===s?{...e,unlocked:!0}:e)})),updateSettings:s=>e(e=>({settings:{...e.settings,...s}})),resetGame:()=>e(a)}),{name:"defeat-the-dragon-storage",partialize:e=>({settings:e.settings,user:e.user})}),{name:"defeat-the-dragon-store"}))},1867:function(e,s,r){r.d(s,{O:function(){return o}});var t=r(7156);r(4859);let o=(0,t.eI)("https://zbqrrtjmavergvuddncs.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpicXJydGptYXZlcmd2dWRkbmNzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU3MDcyNDYsImV4cCI6MjA3MTI4MzI0Nn0.F54csPdpCI6BBhc5NJ5HHJv7LU9xGUGLO1oeGzfUPHE")}}]);